<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenSpace - æ™‚é–“è¨˜éŒ²ç‰ˆ</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="æ™‚é–“ã‚’è¨˜éŒ²ã§ãã‚‹ç‘æƒ³ã‚¿ã‚¤ãƒãƒ¼ã‚¢ãƒ—ãƒª">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ZenSpace">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcikiLz4KPHN2ZyB4PSI0MCIgeT0iNDAiIHdpZHRoPSIxMTIiIGhlaWdodD0iMTEyIiB2aWV3Qm94PSIwIDAgMTEyIDExMiIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik01NiA4QzM2LjExOCA4IDIwIDI0LjExOCAyMCA0NEMyMCA2My44ODIgMzYuMTE4IDgwIDU2IDgwQzc1Ljg4MiA4MCA5MiA2My44ODIgOTIgNDRDOTIgMjQuMTE4IDc1Ljg4MiA4IDU2IDh6IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOSkiLz4KPGV2bGlwc2UgY3g9IjU2IiBjeT0iODAiIHJ4PSI0MCIgcnk9IjI0IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNykiLz4KPHN2ZyB4PSIzNiIgeT0iMjgiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJub25lIj4KPHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSI+CjxjaXJjbGUgY3g9IjIwIiBjeT0iMjAiIHI9IjE4IiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC45KSIgc3Ryb2tlLXdpZHRoPSI0IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9Ik0yMCAxMFYyMEwyNyAyNyIgc3Ryb2tlPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOSkiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4KPHN2ZyB4PSIyNCIgeT0iNjAiIHdpZHRoPSI2NCIgaGVpZ2h0PSI0NCIgdmlld0JveD0iMCAwIDY0IDQ0IiBmaWxsPSJub25lIj4KPHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNDQiIHZpZXdCb3g9IjAgMCA2NCA0NCIgZmlsbD0ibm9uZSI+CjxnIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsLjQpIj4KPGV2bGlwc2UgY3g9IjEwIiBjeT0iMTQiIHJ4PSI0IiByeT0iMyIvPgo8ZWxsaXBzZSBjeD0iMzIiIGN5PSIxMCIgcng9IjYiIHJ5PSI0Ii8+CjxlbGxpcHNlIGN4PSI1NCIgY3k9IjE2IiByeD0iMyIgcnk9IjIiLz4KPGV2bGlwc2UgY3g9IjE0IiBjeT0iMzQiIHJ4PSI1IiByeT0iNCIvPgo8ZWxsaXBzZSBjeD0iNDQiIGN5PSIzMCIgcng9IjQiIHJ5PSIzIi8+CjwvZz4KPC9zdmc+Cjwvc3ZnPgo8L3N2Zz4KPHN2ZyB4PSI3MiIgeT0iMjgiIHdpZHRoPSIxNCIgaGVpZ2h0PSI0NCIgdmlld0JveD0iMCAwIDE0IDQ0IiBmaWxsPSJub25lIj4KPGC9emdgZD0iTSAyIDIgTCA2IDEwIEwgMTAgMiBNIDQgMzAgTCA4IDM4IEwgMTIgMzAiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjQpIiBzdHJva2Utd2lkdGg9IjEuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBmaWxsPSJub25lIi8+Cjwvc3ZnPgo8L3N2Zz4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQwX2xpbmVhciIgeDE9IjAiIHkxPSIwIiB4Mj0iMTkyIiB5Mj0iMTkyIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CjxzdG9wIHN0b3AtY29sb3I9IiM2NjdlZWEiLz4KPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjNzY0YmEyIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPC9zdmc+">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcikiLz4KPHN2ZyB4PSI0MCIgeT0iNDAiIHdpZHRoPSIxMTIiIGhlaWdodD0iMTEyIiB2aWV3Qm94PSIwIDAgMTEyIDExMiIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik01NiA4QzM2LjExOCA4IDIwIDI0LjExOCAyMCA0NEMyMCA2My44ODIgMzYuMTE4IDgwIDU2IDgwQzc1Ljg4MiA4MCA5MiA2My44ODIgOTIgNDRDOTIgMjQuMTE4IDc1Ljg4MiA4IDU2IDh6IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOSkiLz4KPGV2bGlwc2UgY3g9IjU2IiBjeT0iODAiIHJ4PSI0MCIgcnk9IjI0IiBmaWxsPSJyZ2JhKDI1NSwyNTUsMjU1LDAuNykiLz4KPHN2ZyB4PSIzNiIgeT0iMjgiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJub25lIj4KPHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSI+CjxjaXJjbGUgY3g9IjIwIiBjeT0iMjAiIHI9IjE4IiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC45KSIgc3Ryb2tlLXdpZHRoPSI0IiBmaWxsPSJub25lIi8+CjxwYXRoIGQ9Ik0yMCAxMFYyMEwyNyAyNyIgc3Ryb2tlPSJyZ2JhKDI1NSwyNTUsMjU1LDAuOSkiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4KPHN2ZyB4PSIyNCIgeT0iNjAiIHdpZHRoPSI2NCIgaGVpZ2h0PSI0NCIgdmlld0JveD0iMCAwIDY0IDQ0IiBmaWxsPSJub25lIj4KPHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNDQiIHZpZXdCb3g9IjAgMCA2NCA0NCIgZmlsbD0ibm9uZSI+CjxnIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsLjQpIj4KPGV2bGlwc2UgY3g9IjEwIiBjeT0iMTQiIHJ4PSI0IiByeT0iMyIvPgo8ZWxsaXBzZSBjeD0iMzIiIGN5PSIxMCIgcng9IjYiIHJ5PSI0Ii8+CjxlbGxpcHNlIGN4PSI1NCIgY3k9IjE2IiByeD0iMyIgcnk9IjIiLz4KPGV2bGlwc2UgY3g9IjE0IiBjeT0iMzQiIHJ4PSI1IiByeT0iNCIvPgo8ZWxsaXBzZSBjeD0iNDQiIGN5PSIzMCIgcng9IjQiIHJ5PSIzIi8+CjwvZz4KPC9zdmc+Cjwvc3ZnPgo8L3N2Zz4KPHN2ZyB4PSI3MiIgeT0iMjgiIHdpZHRoPSIxNCIgaGVpZ2h0PSI0NCIgdmlld0JveD0iMCAwIDE0IDQ0IiBmaWxsPSJub25lIj4KPGC9emdgZD0iTSAyIDIgTCA2IDEwIEwgMTAgMiBNIDQgMzAgTCA4IDM4IEwgMTIgMzAiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjQpIiBzdHJva2Utd2lkdGg9IjEuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBmaWxsPSJub25lIi8+Cjwvc3ZnPgo8L3N2Zz4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQwX2xpbmVhciIgeDE9IjAiIHkxPSIwIiB4Mj0iMTkyIiB5Mj0iMTkyIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CjxzdG9wIHN0b3AtY29sb3I9IiM2NjdlZWEiLz4KPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjNzY0YmEyIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPC9zdmc+">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            color: white;
            font-size: 2.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        main {
            display: grid;
            gap: 30px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #4a5568;
            margin-bottom: 20px;
            text-align: center;
        }

        .music-upload {
            margin-bottom: 20px;
            text-align: center;
        }

        .music-upload input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            display: inline-block;
            margin-bottom: 15px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.3);
        }

        .music-list {
            margin-bottom: 20px;
        }

        .music-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .music-item:hover {
            background: #e2e8f0;
        }

        .music-item.selected {
            background: linear-gradient(135deg, #4299e1 0%, #667eea 100%);
            color: white;
        }

        .music-info {
            flex: 1;
        }

        .music-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .music-details {
            font-size: 12px;
            opacity: 0.8;
        }

        .music-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            text-align: center;
        }

        .duration-info {
            font-size: 11px;
            margin-top: 2px;
            opacity: 0.7;
        }

        .delete-btn {
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            margin-left: 8px;
            transition: background 0.2s;
        }

        .delete-btn:hover {
            background: #c53030;
        }

        .music-actions {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #clear-all-btn:hover {
            background: #c53030 !important;
        }

        .audio-controls {
            text-align: center;
            margin-bottom: 30px;
        }

        #meditation-audio {
            width: 100%;
            max-width: 400px;
        }

        .meditation-status {
            text-align: center;
        }

        #status-message {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px;
            color: #4a5568;
        }

        #start-btn {
            background: linear-gradient(135deg, #4299e1 0%, #667eea 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }

        #start-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, #4299e1 0%, #667eea 100%);
            color: white;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .time-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .time-stat-item {
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, #38a169 0%, #48bb78 100%);
            color: white;
            border-radius: 10px;
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .nav-btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        .nav-btn:hover {
            background: #3182ce;
        }

        .nav-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .current-month {
            font-weight: 600;
            color: #2d3748;
        }

        #calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            max-width: 350px;
            margin: 0 auto;
        }

        .calendar-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: #f7fafc;
            color: #4a5568;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            position: relative;
        }

        .calendar-day:hover {
            background: #e2e8f0;
        }

        .calendar-day.completed {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            font-weight: bold;
        }

        .calendar-day.today {
            border: 2px solid #4299e1;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .time-badge {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 8px;
            background: rgba(0,0,0,0.3);
            color: white;
            padding: 1px 3px;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            .section {
                padding: 20px;
            }
            
            #calendar {
                max-width: 300px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .time-stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.8rem;
            }
            
            .section {
                padding: 15px;
            }
            
            #start-btn, .upload-btn {
                width: 100%;
                padding: 12px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .time-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”® ZenSpace</h1>
        </header>
        
        <main>
            <!-- éŸ³æ¥½é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>éŸ³æ¥½é¸æŠ</h2>
                
                <div class="music-upload">
                    <input type="file" id="music-file" accept="audio/mp3,audio/mpeg" multiple>
                    <label for="music-file" class="upload-btn">MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                    <button id="clear-all-btn" onclick="clearAllSavedFiles()" style="background: #e53e3e; color: white; border: none; padding: 8px 16px; border-radius: 15px; font-size: 12px; cursor: pointer; margin-left: 10px; transition: background 0.2s;">å…¨å‰Šé™¤</button>
                    <p style="color: #718096; font-size: 14px;">ä¸€åº¦ã«è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã§ãã¾ã™</p>
                    <div id="storage-info" style="font-size: 12px; color: #718096; margin-top: 10px;"></div>
                    
                    <!-- é€²æ—è¡¨ç¤º -->
                    <div id="upload-progress" style="display: none; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span id="progress-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...</span>
                            <span id="progress-percent">0%</span>
                        </div>
                        <div style="background: #e2e8f0; border-radius: 10px; height: 8px; overflow: hidden;">
                            <div id="progress-bar" style="background: linear-gradient(135deg, #4299e1 0%, #667eea 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <div id="file-status" style="margin-top: 10px; font-size: 12px; color: #718096;"></div>
                    </div>
                </div>
                
                <div class="music-list" id="music-list"></div>
                
                <div class="audio-controls">
                    <audio id="meditation-audio" controls style="display: none;">
                        <source id="audio-source" type="audio/mpeg">
                        ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªè¦ç´ ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
                    </audio>
                </div>
                
                <div class="meditation-status">
                    <div id="status-message">éŸ³æ¥½ã‚’é¸æŠã—ã¦ç‘æƒ³ã‚’å§‹ã‚ã¦ãã ã•ã„</div>
                    <button id="start-btn" disabled>ç‘æƒ³é–‹å§‹</button>
                </div>
            </div>

            <!-- çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ç‘æƒ³çµ±è¨ˆ</h2>
                
                <!-- å›æ•°çµ±è¨ˆ -->
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="streak-count">0</span>
                        <span class="stat-label">é€£ç¶šæ—¥æ•°</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="total-count">0</span>
                        <span class="stat-label">ç·æ—¥æ•°</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="this-month-count">0</span>
                        <span class="stat-label">ä»Šæœˆ</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="this-week-count">0</span>
                        <span class="stat-label">ä»Šé€±</span>
                    </div>
                </div>

                <!-- æ™‚é–“çµ±è¨ˆ -->
                <div class="time-stats">
                    <div class="time-stat-item">
                        <span class="stat-value" id="total-time">0åˆ†</span>
                        <span class="stat-label">ç´¯è¨ˆæ™‚é–“</span>
                    </div>
                    <div class="time-stat-item">
                        <span class="stat-value" id="this-month-time">0åˆ†</span>
                        <span class="stat-label">ä»Šæœˆæ™‚é–“</span>
                    </div>
                    <div class="time-stat-item">
                        <span class="stat-value" id="this-week-time">0åˆ†</span>
                        <span class="stat-label">ä»Šé€±æ™‚é–“</span>
                    </div>
                </div>
            </div>
            
            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ç‘æƒ³è¨˜éŒ²</h2>
                <div class="calendar-nav">
                    <button class="nav-btn" id="prev-month">â—€</button>
                    <span class="current-month" id="current-month-display"></span>
                    <button class="nav-btn" id="next-month">â–¶</button>
                </div>
                <div id="calendar"></div>
            </div>
        </main>
    </div>
    
    <script>
        let selectedMusicIndex = -1;
        let meditationInProgress = false;
        let musicFiles = [];
        let currentViewDate = new Date();
        let selectedMusicDuration = 0;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéŸ³æ¥½è¨­å®šï¼ˆåŸ‹ã‚è¾¼ã¿ç”¨ï¼‰
        const defaultSounds = [
            { name: "ãŠæ°—ã«å…¥ã‚Šã®éŸ³æ¥½", duration: 0, type: "file", path: "path/to/your/music.mp3" } // ã‚ãªãŸã®MP3ãƒ•ã‚¡ã‚¤ãƒ«
        ];
        
        const musicFileInput = document.getElementById('music-file');
        const musicList = document.getElementById('music-list');
        const audio = document.getElementById('meditation-audio');
        const audioSourceElement = document.getElementById('audio-source');
        const startBtn = document.getElementById('start-btn');
        const statusMessage = document.getElementById('status-message');
        const calendar = document.getElementById('calendar');
        const currentMonthDisplay = document.getElementById('current-month-display');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const storageInfo = document.getElementById('storage-info');
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ç‘æƒ³è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿
        function loadMeditationData() {
            const data = localStorage.getItem('meditationData');
            return data ? JSON.parse(data) : { 
                completedDates: [], 
                sessions: [] // { date, duration } ã®é…åˆ—
            };
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ç‘æƒ³è¨˜éŒ²ã‚’ä¿å­˜
        function saveMeditationData(data) {
            localStorage.setItem('meditationData', JSON.stringify(data));
        }
        
        // æ™‚é–“ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆç§’ â†’ åˆ†:ç§’ or æ™‚é–“:åˆ†ï¼‰
        function formatTime(seconds) {
            if (seconds < 60) {
                return `${Math.round(seconds)}ç§’`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.round(seconds % 60);
                return secs > 0 ? `${minutes}åˆ†${secs}ç§’` : `${minutes}åˆ†`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return minutes > 0 ? `${hours}æ™‚é–“${minutes}åˆ†` : `${hours}æ™‚é–“`;
            }
        }
        
        // LocalStorageã‹ã‚‰ä¿å­˜æ¸ˆã¿éŸ³æ¥½ã‚’èª­ã¿è¾¼ã¿
        function loadSavedMusic() {
            const saved = localStorage.getItem('savedMusicFiles');
            if (saved) {
                const savedFiles = JSON.parse(saved);
                return savedFiles.map(fileData => ({
                    name: fileData.name,
                    data: fileData.data,
                    size: fileData.size
                }));
            }
            return [];
        }
        
        // LocalStorageã®ä½¿ç”¨é‡ã‚’ãƒã‚§ãƒƒã‚¯
        function getLocalStorageSize() {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length + key.length;
                }
            }
            return total;
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’æ¨å®šï¼ˆBase64ã¯å…ƒã‚µã‚¤ã‚ºã®ç´„1.33å€ï¼‰
        function estimateStorageSize(files) {
            return files.reduce((total, file) => {
                if (file.data) {
                    return total + file.data.length;
                } else {
                    return total + (file.size * 1.33); // Base64å¤‰æ›å¾Œã®æ¨å®šã‚µã‚¤ã‚º
                }
            }, 0);
        }
        
        // LocalStorageã«éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ï¼ˆå®¹é‡åˆ¶é™å¯¾å¿œï¼‰
        function saveMusicFiles(files) {
            try {
                const filesToSave = files.map(file => ({
                    name: file.name,
                    data: file.data || null,
                    size: file.size
                }));
                
                const dataString = JSON.stringify(filesToSave);
                const currentSize = getLocalStorageSize();
                const newDataSize = dataString.length;
                const totalSize = currentSize + newDataSize;
                
                // 5MBã‚’è¶…ãˆã‚‹å ´åˆã¯è­¦å‘Šï¼ˆã‚¹ãƒãƒ›ã§ã®æ¨™æº–å®¹é‡ï¼‰
                if (totalSize > 5 * 1024 * 1024) {
                    throw new Error('QUOTA_EXCEEDED');
                }
                
                localStorage.setItem('savedMusicFiles', dataString);
                return true;
            } catch (error) {
                if (error.name === 'QuotaExceededError' || error.message === 'QUOTA_EXCEEDED') {
                    handleStorageQuotaExceeded(files);
                    return false;
                } else {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    return false;
                }
            }
        }
        
        // å®¹é‡è¶…éæ™‚ã®å‡¦ç†
        function handleStorageQuotaExceeded(files) {
            alert(`å®¹é‡ä¸è¶³: ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¿å­˜å®¹é‡ã‚’è¶…ãˆã¾ã—ãŸã€‚\n\nå¯¾å‡¦æ³•:\n1. å°ã•ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨\n2. ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’æ¸›ã‚‰ã™\n3. ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»\n\nç¾åœ¨ã®ä½¿ç”¨é‡: ${Math.round(getLocalStorageSize() / 1024)}KB\næ¨å®šå¿…è¦å®¹é‡: ${Math.round(estimateStorageSize(files) / 1024)}KB`);
            
            // æ—¢å­˜ã®ä¿å­˜æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ç¢ºèª
            const saved = loadSavedMusic();
            if (saved.length > 0) {
                if (confirm('ä¿å­˜æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) {
                    localStorage.removeItem('savedMusicFiles');
                    
                    // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã§å†è©¦è¡Œ
                    const newFiles = files.filter(file => !file.data);
                    if (newFiles.length > 0 && saveMusicFiles(newFiles)) {
                        statusMessage.textContent = 'å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚';
                    }
                }
            }
        }
        
        // ä¿å­˜æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        function deleteSavedFile(index) {
            if (index < 0 || index >= musicFiles.length) return;
            
            const file = musicFiles[index];
            const confirmMessage = `ã€Œ${file.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
            
            if (confirm(confirmMessage)) {
                // é¸æŠä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã‚‹å ´åˆã®å‡¦ç†
                if (selectedMusicIndex === index) {
                    selectedMusicIndex = -1;
                    startBtn.disabled = true;
                    audio.style.display = 'none';
                    statusMessage.textContent = 'å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚æ–°ã—ã„éŸ³æ¥½ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
                } else if (selectedMusicIndex > index) {
                    // é¸æŠä¸­ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’èª¿æ•´
                    selectedMusicIndex--;
                }
                
                // é…åˆ—ã‹ã‚‰å‰Šé™¤
                musicFiles.splice(index, 1);
                
                // LocalStorageã‚’æ›´æ–°
                saveMusicFiles(musicFiles);
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                displayMusicList();
                updateStorageInfo();
                
                statusMessage.textContent = `ã€Œ${file.name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`;
                
                // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
                setTimeout(() => {
                    if (musicFiles.length > 0) {
                        statusMessage.textContent = 'éŸ³æ¥½ã‚’é¸æŠã—ã¦ç‘æƒ³ã‚’å§‹ã‚ã¦ãã ã•ã„';
                    } else {
                        statusMessage.textContent = 'MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ç‘æƒ³ã‚’å§‹ã‚ã¦ãã ã•ã„';
                    }
                }, 3000);
            }
        }
        
        // å…¨ã¦ã®ä¿å­˜æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        function clearAllSavedFiles() {
            if (musicFiles.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const confirmMessage = `ä¿å­˜æ¸ˆã¿ã®${musicFiles.length}å€‹å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
            
            if (confirm(confirmMessage)) {
                musicFiles = [];
                selectedMusicIndex = -1;
                startBtn.disabled = true;
                audio.style.display = 'none';
                
                // LocalStorageã‚’ã‚¯ãƒªã‚¢
                localStorage.removeItem('savedMusicFiles');
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                displayMusicList();
                updateStorageInfo();
                
                statusMessage.textContent = 'å…¨ã¦ã®ä¿å­˜æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚';
                
                setTimeout(() => {
                    statusMessage.textContent = 'MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ç‘æƒ³ã‚’å§‹ã‚ã¦ãã ã•ã„';
                }, 3000);
            }
        }

        // å®¹é‡æƒ…å ±ã‚’æ›´æ–°
        function updateStorageInfo() {
            const currentSize = getLocalStorageSize();
            const maxSize = 5 * 1024 * 1024; // 5MBï¼ˆã‚¹ãƒãƒ›æ¨™æº–å®¹é‡ï¼‰
            const usagePercent = Math.round((currentSize / maxSize) * 100);
            const currentMB = (currentSize / 1024 / 1024).toFixed(2);
            
            let statusColor = '#718096';
            if (usagePercent > 80) statusColor = '#e53e3e';
            else if (usagePercent > 60) statusColor = '#dd6b20';
            
            storageInfo.innerHTML = `
                ãƒ–ãƒ©ã‚¦ã‚¶å®¹é‡ä½¿ç”¨çŠ¶æ³: ${currentMB}MB / 5MB (${usagePercent}%) ğŸ“±ã‚¹ãƒãƒ›å¯¾å¿œ
                ${usagePercent > 80 ? ' âš ï¸ å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™' : ''}
            `;
            storageInfo.style.color = statusColor;
        }
        
        // é€²æ—è¡¨ç¤ºè¦ç´ ã‚’å–å¾—
        const uploadProgress = document.getElementById('upload-progress');
        const progressText = document.getElementById('progress-text');
        const progressPercent = document.getElementById('progress-percent');
        const progressBar = document.getElementById('progress-bar');
        const fileStatus = document.getElementById('file-status');
        
        // é€²æ—ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateProgress(current, total, fileName = '') {
            const percent = Math.round((current / total) * 100);
            progressPercent.textContent = `${percent}%`;
            progressBar.style.width = `${percent}%`;
            
            if (fileName) {
                progressText.textContent = `å‡¦ç†ä¸­: ${fileName}`;
                fileStatus.textContent = `${current}/${total}ãƒ•ã‚¡ã‚¤ãƒ«å®Œäº†`;
            }
        }
        
        // é€²æ—è¡¨ç¤ºã‚’é–‹å§‹
        function showProgress() {
            uploadProgress.style.display = 'block';
            updateProgress(0, 1);
        }
        
        // é€²æ—è¡¨ç¤ºã‚’éš ã™
        function hideProgress() {
            setTimeout(() => {
                uploadProgress.style.display = 'none';
            }, 1000);
        }
        
        // éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†ï¼ˆé€²æ—è¡¨ç¤ºä»˜ãï¼‰
        musicFileInput.addEventListener('change', async function(e) {
            const newFiles = Array.from(e.target.files);
            if (newFiles.length === 0) return;
            
            showProgress();
            progressText.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...';
            
            try {
                // å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é †ç•ªã«å‡¦ç†ã—ã¦é€²æ—ã‚’è¡¨ç¤º
                const convertedFiles = [];
                
                for (let i = 0; i < newFiles.length; i++) {
                    const file = newFiles[i];
                    updateProgress(i, newFiles.length, file.name);
                    
                    const convertedFile = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            resolve({
                                name: file.name,
                                size: file.size,
                                data: e.target.result
                            });
                        };
                        reader.onerror = () => reject(new Error(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${file.name}`));
                        reader.readAsDataURL(file);
                    });
                    
                    convertedFiles.push(convertedFile);
                    
                    // å°‘ã—å¾…æ©Ÿã—ã¦é€²æ—ã‚’è¦–è¦šçš„ã«ç¢ºèªã—ã‚„ã™ãã™ã‚‹
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // æœ€çµ‚æ®µéš: LocalStorageã«ä¿å­˜
                updateProgress(newFiles.length, newFiles.length, '');
                progressText.textContent = 'ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ä¸­...';
                
                // æ—¢å­˜ã®ä¿å­˜æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã¨çµåˆ
                const savedFiles = loadSavedMusic();
                musicFiles = [...savedFiles, ...convertedFiles];
                
                // LocalStorageã«ä¿å­˜ï¼ˆå¤±æ•—æ™‚ã®å¯¾å¿œï¼‰
                const saveSuccess = saveMusicFiles(musicFiles);
                if (!saveSuccess) {
                    // ä¿å­˜ã«å¤±æ•—ã—ãŸå ´åˆã€ãƒ¡ãƒ¢ãƒªä¸Šã§ã®ã¿ç®¡ç†
                    progressText.textContent = 'ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã¯ä½¿ç”¨ã§ãã¾ã™';
                    fileStatus.textContent = 'ãƒ–ãƒ©ã‚¦ã‚¶ã®å®¹é‡ä¸è¶³ã®ãŸã‚ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
                }
                
                displayMusicList();
                
                // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                progressText.textContent = 'å®Œäº†ã—ã¾ã—ãŸï¼';
                progressPercent.textContent = '100%';
                fileStatus.textContent = `${convertedFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ`;
                
                if (convertedFiles.length > 0) {
                    statusMessage.textContent = `${convertedFiles.length}å€‹ã®æ–°ã—ã„éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚ãŠæ°—ã«å…¥ã‚Šã‚’é¸ã‚“ã§ãã ã•ã„ã€‚`;
                }
                
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                progressText.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                fileStatus.textContent = error.message;
            } finally {
                hideProgress();
            }
        });
        

        // éŸ³æ¥½ãƒªã‚¹ãƒˆè¡¨ç¤º
        function displayMusicList() {
            musicList.innerHTML = '';
            
            musicFiles.forEach((file, index) => {
                const musicItem = document.createElement('div');
                musicItem.className = 'music-item';
                if (selectedMusicIndex === index) {
                    musicItem.classList.add('selected');
                }
                
                musicItem.innerHTML = `
                    <div class="music-info">
                        <div class="music-name">${file.name}</div>
                        <div class="music-details">${(file.size / 1024 / 1024).toFixed(1)}MB</div>
                        <div class="duration-info">é•·ã•: å–å¾—ä¸­...</div>
                    </div>
                    <div class="music-actions">
                        <div class="music-status">${selectedMusicIndex === index ? 'é¸æŠä¸­' : 'ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ'}</div>
                        ${file.data ? `<button class="delete-btn" onclick="deleteSavedFile(${index}); event.stopPropagation();">å‰Šé™¤</button>` : ''}
                    </div>
                `;
                
                // ä»®ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§é•·ã•ã‚’å–å¾—
                const tempAudio = new Audio();
                tempAudio.preload = 'metadata';
                
                if (file.data) {
                    // LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆBase64ãƒ‡ãƒ¼ã‚¿ï¼‰
                    tempAudio.src = file.data;
                    tempAudio.onloadedmetadata = function() {
                        const durationElement = musicItem.querySelector('.duration-info');
                        if (durationElement) {
                            durationElement.textContent = `é•·ã•: ${formatTime(tempAudio.duration)}`;
                        }
                    };
                } else if (file instanceof File) {
                    // æ–°è¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        tempAudio.src = e.target.result;
                        tempAudio.onloadedmetadata = function() {
                            const durationElement = musicItem.querySelector('.duration-info');
                            if (durationElement) {
                                durationElement.textContent = `é•·ã•: ${formatTime(tempAudio.duration)}`;
                            }
                        };
                    };
                    reader.readAsDataURL(file);
                } else {
                    // ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ˜ãªå ´åˆ
                    const durationElement = musicItem.querySelector('.duration-info');
                    if (durationElement) {
                        durationElement.textContent = 'é•·ã•: ä¸æ˜';
                    }
                }
                
                musicItem.addEventListener('click', function() {
                    selectMusic(index);
                });
                
                musicList.appendChild(musicItem);
            });
        }
        

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        function selectMusic(index) {
            if (index < 0 || index >= musicFiles.length) return;
            
            selectedMusicIndex = index;
            const file = musicFiles[index];
            
            // Base64ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼ˆLocalStorageã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸï¼‰
            if (file.data) {
                audioSourceElement.src = file.data;
                audio.load();
                audio.style.display = 'block';
                
                // éŸ³æ¥½ã®é•·ã•ã‚’å–å¾—
                audio.onloadedmetadata = function() {
                    selectedMusicDuration = audio.duration;
                    startBtn.disabled = false;
                    statusMessage.textContent = `${file.name} (${formatTime(selectedMusicDuration)}) ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚ç‘æƒ³ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚`;
                };
            } else {
                // Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆï¼ˆæ–°è¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
                const reader = new FileReader();
                reader.onload = function(e) {
                    audioSourceElement.src = e.target.result;
                    audio.load();
                    audio.style.display = 'block';
                    
                    // éŸ³æ¥½ã®é•·ã•ã‚’å–å¾—
                    audio.onloadedmetadata = function() {
                        selectedMusicDuration = audio.duration;
                        startBtn.disabled = false;
                        statusMessage.textContent = `${file.name} (${formatTime(selectedMusicDuration)}) ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚ç‘æƒ³ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚`;
                    };
                };
                reader.readAsDataURL(file);
            }
            
            displayMusicList(); // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã‚’å–å¾—ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œï¼‰
        function getLocalDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // ç‘æƒ³é–‹å§‹
        startBtn.addEventListener('click', function() {
            if (!meditationInProgress && selectedMusicIndex >= 0) {
                startMeditation();
            }
        });
        
        async function startMeditation() {
            meditationInProgress = true;
            startBtn.textContent = 'ç‘æƒ³ä¸­...';
            startBtn.disabled = true;
            statusMessage.textContent = `ç‘æƒ³ä¸­... éŸ³æ¥½ãŒçµ‚ã‚ã‚‹ã¾ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ãã ã•ã„ ğŸ§˜ (${formatTime(selectedMusicDuration)})`;
            
            try {
                // MP3ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿ
                await audio.play();
            } catch (error) {
                console.error('éŸ³æ¥½ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                alert('éŸ³æ¥½ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                meditationInProgress = false;
                startBtn.textContent = 'ç‘æƒ³é–‹å§‹';
                startBtn.disabled = false;
            }
        }
        
        // éŸ³æ¥½çµ‚äº†æ™‚ã®å‡¦ç†
        audio.addEventListener('ended', function() {
            completeMeditation();
        });
        
        // ç‘æƒ³å®Œäº†å‡¦ç†
        function completeMeditation() {
            if (!meditationInProgress) return;
            
            meditationInProgress = false;
            startBtn.textContent = 'ç‘æƒ³é–‹å§‹';
            startBtn.disabled = false;
            statusMessage.textContent = `ç‘æƒ³ãŒå®Œäº†ã—ã¾ã—ãŸï¼${formatTime(selectedMusicDuration)}ãŠç–²ã‚Œæ§˜ã§ã—ãŸ ğŸ‰`;
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã¨ç‘æƒ³æ™‚é–“ã‚’è¨˜éŒ²
            const today = getLocalDateString();
            const data = loadMeditationData();
            
            // å¾“æ¥ã®æ—¥ä»˜è¨˜éŒ²ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
            if (!data.completedDates.includes(today)) {
                data.completedDates.push(today);
            }
            
            // æ–°ã—ã„æ™‚é–“è¨˜éŒ²
            data.sessions = data.sessions || [];
            data.sessions.push({
                date: today,
                duration: selectedMusicDuration,
                timestamp: new Date().toISOString()
            });
            
            saveMeditationData(data);
            renderCalendar();
            updateStats();
            
            setTimeout(() => {
                statusMessage.textContent = 'éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ç‘æƒ³ã‚’å§‹ã‚ã¦ãã ã•ã„';
            }, 3000);
        }
        
        // éŸ³æ¥½ä¸€æ™‚åœæ­¢/å†ç”Ÿæ™‚ã®å‡¦ç†
        audio.addEventListener('pause', function() {
            if (meditationInProgress && !audio.ended) {
                statusMessage.textContent = 'ç‘æƒ³ãŒä¸€æ™‚åœæ­¢ã•ã‚Œã¾ã—ãŸã€‚å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç¶šã‘ã¦ãã ã•ã„ã€‚';
            }
        });
        
        audio.addEventListener('play', function() {
            if (meditationInProgress) {
                statusMessage.textContent = `ç‘æƒ³ä¸­... éŸ³æ¥½ãŒçµ‚ã‚ã‚‹ã¾ã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ãã ã•ã„ ğŸ§˜ (${formatTime(selectedMusicDuration)})`;
            }
        });
        
        // é€£ç¶šæ—¥æ•°ã‚’è¨ˆç®—
        function calculateStreak() {
            const data = loadMeditationData();
            const dates = data.completedDates.sort();
            
            if (dates.length === 0) return 0;
            
            let streak = 0;
            const today = getLocalDateString();
            const yesterday = getLocalDateString(new Date(Date.now() - 24 * 60 * 60 * 1000));
            
            // ä»Šæ—¥ã¾ãŸã¯æ˜¨æ—¥ã‹ã‚‰é€†ç®—
            let checkDate = dates.includes(today) ? today : (dates.includes(yesterday) ? yesterday : null);
            
            if (!checkDate) return 0;
            
            let currentDate = new Date(checkDate);
            
            while (dates.includes(getLocalDateString(currentDate))) {
                streak++;
                currentDate.setDate(currentDate.getDate() - 1);
            }
            
            return streak;
        }
        
        // æœŸé–“å†…ã®ç‘æƒ³æ™‚é–“ã‚’è¨ˆç®—
        function calculateTimeInPeriod(startDate, endDate = null) {
            const data = loadMeditationData();
            const sessions = data.sessions || [];
            
            return sessions.filter(session => {
                const sessionDate = new Date(session.date);
                const start = new Date(startDate);
                const end = endDate ? new Date(endDate) : new Date();
                
                return sessionDate >= start && sessionDate <= end;
            }).reduce((total, session) => total + (session.duration || 0), 0);
        }
        
        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        function updateStats() {
            const data = loadMeditationData();
            const dates = data.completedDates;
            const sessions = data.sessions || [];
            const today = new Date();
            const thisMonth = today.getMonth();
            const thisYear = today.getFullYear();
            
            // é€£ç¶šæ—¥æ•°
            document.getElementById('streak-count').textContent = calculateStreak();
            
            // ç·æ—¥æ•°
            document.getElementById('total-count').textContent = dates.length;
            
            // ä»Šæœˆã®æ—¥æ•°
            const thisMonthCount = dates.filter(date => {
                const d = new Date(date);
                return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
            }).length;
            document.getElementById('this-month-count').textContent = thisMonthCount;
            
            // ä»Šé€±ã®æ—¥æ•°
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            
            const thisWeekCount = dates.filter(date => {
                const d = new Date(date);
                return d >= startOfWeek;
            }).length;
            document.getElementById('this-week-count').textContent = thisWeekCount;
            
            // æ™‚é–“çµ±è¨ˆ
            const totalTime = sessions.reduce((sum, session) => sum + (session.duration || 0), 0);
            document.getElementById('total-time').textContent = formatTime(totalTime);
            
            // ä»Šæœˆã®æ™‚é–“
            const startOfMonth = new Date(thisYear, thisMonth, 1);
            const thisMonthTime = calculateTimeInPeriod(startOfMonth);
            document.getElementById('this-month-time').textContent = formatTime(thisMonthTime);
            
            // ä»Šé€±ã®æ™‚é–“  
            const thisWeekTime = calculateTimeInPeriod(startOfWeek);
            document.getElementById('this-week-time').textContent = formatTime(thisWeekTime);
            
        }
        
        // æ—¥ä»˜ã®ç‘æƒ³æ™‚é–“ã‚’å–å¾—
        function getDayMeditationTime(dateStr) {
            const data = loadMeditationData();
            const sessions = data.sessions || [];
            
            return sessions
                .filter(session => session.date === dateStr)
                .reduce((total, session) => total + (session.duration || 0), 0);
        }
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º
        function renderCalendar() {
            calendar.innerHTML = '';
            
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            weekdays.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            const viewMonth = currentViewDate.getMonth();
            const viewYear = currentViewDate.getFullYear();
            const firstDay = new Date(viewYear, viewMonth, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const data = loadMeditationData();
            const today = new Date();
            
            // æœˆè¡¨ç¤ºã‚’æ›´æ–°
            currentMonthDisplay.textContent = `${viewYear}å¹´${viewMonth + 1}æœˆ`;
            
            // å‰/æ¬¡æœˆãƒœã‚¿ãƒ³ã®åˆ¶å¾¡ï¼ˆéå»6ãƒ¶æœˆã¾ã§ï¼‰
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(today.getMonth() - 6);
            
            prevMonthBtn.disabled = currentViewDate <= sixMonthsAgo;
            nextMonthBtn.disabled = currentViewDate >= today;
            
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = cellDate.getDate();
                
                if (cellDate.getMonth() !== viewMonth) {
                    dayElement.classList.add('other-month');
                }
                
                const dateStr = getLocalDateString(cellDate);
                if (data.completedDates.includes(dateStr)) {
                    dayElement.classList.add('completed');
                    
                    // æ™‚é–“ãƒãƒƒã‚¸ã‚’è¿½åŠ 
                    const dayTime = getDayMeditationTime(dateStr);
                    if (dayTime > 0) {
                        const timeBadge = document.createElement('div');
                        timeBadge.className = 'time-badge';
                        timeBadge.textContent = formatTime(dayTime).replace('æ™‚é–“', 'h').replace('åˆ†', 'm').replace('ç§’', 's');
                        dayElement.appendChild(timeBadge);
                    }
                }
                
                if (cellDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                calendar.appendChild(dayElement);
            }
        }
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        prevMonthBtn.addEventListener('click', function() {
            currentViewDate.setMonth(currentViewDate.getMonth() - 1);
            renderCalendar();
        });
        
        nextMonthBtn.addEventListener('click', function() {
            currentViewDate.setMonth(currentViewDate.getMonth() + 1);
            renderCalendar();
        });
        
        // Service Workerç™»éŒ²
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then((registration) => {
                    console.log('Service Worker ç™»éŒ²æˆåŠŸ:', registration);
                })
                .catch((error) => {
                    console.error('Service Worker ç™»éŒ²å¤±æ•—:', error);
                });
        }

        // PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤ºå¯èƒ½');
            e.preventDefault();
            deferredPrompt = e;
            
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹å ´åˆã¯ã“ã“ã«å®Ÿè£…
            showInstallPromotion();
        });

        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        function showInstallPromotion() {
            const installBanner = document.createElement('div');
            installBanner.innerHTML = `
                <div style="position: fixed; top: 10px; right: 10px; background: #667eea; color: white; padding: 10px 15px; border-radius: 8px; font-size: 14px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                    <span>ğŸ“± ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</span>
                    <button id="install-btn" style="background: white; color: #667eea; border: none; padding: 5px 10px; margin-left: 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
                    <button id="dismiss-btn" style="background: none; color: white; border: none; cursor: pointer; font-size: 12px; margin-left: 5px;">âœ•</button>
                </div>
            `;
            
            document.body.appendChild(installBanner);
            
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
            document.getElementById('install-btn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çµæœ:', outcome);
                    deferredPrompt = null;
                    installBanner.remove();
                }
            });
            
            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³å‡¦ç†
            document.getElementById('dismiss-btn').addEventListener('click', () => {
                installBanner.remove();
            });
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderCalendar();
            updateStats();
            updateStorageInfo(); // å®¹é‡æƒ…å ±ã‚’è¡¨ç¤º
            
            // ä¿å­˜æ¸ˆã¿éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            musicFiles = loadSavedMusic();
            displayMusicList();
            
            // ä¿å­˜æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•é¸æŠ
            if (musicFiles.length > 0) {
                selectMusic(0); // æœ€åˆã®ä¿å­˜æ¸ˆã¿éŸ³æ¥½ã‚’é¸æŠ
                statusMessage.textContent = `ä¿å­˜æ¸ˆã¿ã®éŸ³æ¥½ã€Œ${musicFiles[0].name}ã€ãŒè‡ªå‹•é¸æŠã•ã‚Œã¾ã—ãŸã€‚`;
            } else {
                statusMessage.textContent = 'MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ç‘æƒ³ã‚’å§‹ã‚ã¦ãã ã•ã„';
            }
        });
    </script>
</body>
</html>